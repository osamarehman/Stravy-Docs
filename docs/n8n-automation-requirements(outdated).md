**Project:** Stryv Academics MVP Development

**Document:** n8n Workflow Specifications

**Launch Target:** November 21, 2025

**Last Updated:** November 4, 2025, 5:00pm

---

## Overview

This document specifies all n8n workflows required for Phase 1 launch. Each workflow is triggered by Airtable webhooks, Xero webhooks, Webflow webhooks, Softr form submissions, or scheduled polling.

**Total Workflows: 33**

**Architecture Approach:**
- **Atomic Design:** Each wemorkflow has single responsibility
- **Event-Driven:** Airtable status changes trigger webhooks to n8n
- **Hybrid Polling:** Non-time-critical status checks use scheduled polling
- **Webhook Security:** All external webhooks must validate signatures

**Related Documents:**
- Airtable Automations Requirements: Specifications for Airtable automations that trigger these workflows
- Integration Flow Map: End-to-end business process flows
- Developer Scope: Timeline and deliverables

**Record ID Conventions:**

New records created post-migration use formatted IDs for professional appearance:
- Lessons: LSN-YYYY-#### (e.g., LSN-2025-0001)
- Payments: PAY-YYYY-#### (e.g., PAY-2025-0042)
- Payouts: PYO-YYYY-#### (e.g., PYO-2025-0015)
- Packages: PKG-#### (existing format maintained)

These are auto-generated by Airtable using auto-number fields with custom formatting.

**Internal Airtable Automations:**

Four internal Airtable automations handle data management within Airtable and do NOT trigger n8n workflows:
- AT-TP14: Auto-Resolve Package (when all payments paid and payout complete)
- AT-TP15: Create Payout Record (when package completes)
- AT-TP17: Create Main Invoice Payment Record (when package created)
- AT-TP18: Create Additional Fees Payment Record (when additional fees invoice created)

These are documented in the Airtable Automations Requirements document.

---

## Workflow Numbering System

Workflows are organized by business function using alphabetic prefixes:

- **L-Series:** Lesson Management (LE1, L1, L2, LSP1)
- **TA-Series:** Tutor Applications (TA1-TA5, TA3b, TASP1)
- **TP-Series:** Tutoring Package & Invoice Management (TP1-TP12, TPE1, TPSP1)
- **PAY-Series:** Payment Tracking (PAYE1-PAYE3)
- **U-Series:** User Management (UE1, U1, UE2, U2)

**Role-Specific Workflows (Reserved for Phase 2):**
- **T-series:** Tutor-specific workflows
- **P-series:** Parent-specific workflows
- **S-series:** Student-specific workflows

**Suffix Conventions:**
- **E suffix:** External webhooks (Xero, Webflow, Softr forms, e-signature service)
- **SP suffix:** Scheduled polling workflows

**Example:** Workflow TP7 = Send PO Email

---

## L-Series: Lesson Management

### Workflow LE1: Lesson Submission Handler

**Responsibility:** Validate lesson report submission, create Airtable record, determine verification requirements

**Trigger:** Softr form submission (POST request to n8n webhook URL)

**Actions:**
1. **Receive form data via webhook:**
- Package ID, Student ID, Lesson Date, Start Time, End Time, Duration
- Location (In-Person/Online), Transportation Reimbursement (if applicable)
- Type (Regular Lesson / Late Cancellation)
- Tutor notes, homework assigned, student behavior, etc.

1. **Validate form data:**
    - All required fields present
    - End Time > Start Time
    - Duration between 15 minutes and 5 hours
    - Calculate submission timing: time between lesson end and current time
    - Timing thresholds:
        - TARGET (for optimal tutor evaluation): â‰¤ 2 hours after lesson end
        - GRACE PERIOD (system â€œOn Timeâ€ threshold): â‰¤ 6 hours after lesson end
        - LATE: > 6 hours after lesson end
2. **If validation fails:**
    - Return HTTP 400 with specific error message to Softr
    - Display error to tutor in form
3. **Fetch Package record from Airtable:**
    - Total Hours Expected, Hours Delivered (current), Hourly Session Rate
    - Package Status
4. **Calculate hours and check verification needs:**
    
    ```
    Hours Counted = Lesson Duration
    Amount = Hours Counted Ã— Hourly Session Rate
    New Hours Delivered = Current Hours Delivered + Hours Counted
    
    Needs Verification IF:
      - New Hours Delivered > Total Hours Expected (over-delivery)
      OR Type = "Late Cancellation"
      OR Transportation Reimbursement > 0
    ```
    
5. **Create Airtable Lessons table record:**
    - All form field data
    - Hours Counted, Amount (calculated above)
    - `Lesson Report Submitted At` = current timestamp
    - `Lesson Report Status` = â€œCompletedâ€ (if within 6 hours) OR â€œLateâ€ (if after 6 hours)
    
    **Verification Fields:**
    
    - IF over-delivery: `Over-Delivery Verified` = FALSE
    - ELSE: `Over-Delivery Verified` = TRUE
    - IF Type = â€œLate Cancellationâ€: `Late Cancellation Verified` = FALSE
    - ELSE: `Late Cancellation Verified` = TRUE
    - IF Transportation Reimbursement > 0: `Transportation Verified` = FALSE
    - ELSE: `Transportation Verified` = TRUE
    
    **Status:**
    
    - IF any verification = FALSE: `Lesson Status` = â€œPending Verificationâ€
    - ELSE: `Lesson Status` = â€œVerifiedâ€
6. **No Package field updates needed:**
    - `Hours Delivered` is automatic Airtable rollup
    - `Transportation Reimbursement` is automatic Airtable rollup
    - `Late Cancellation Fees` is automatic Airtable rollup
7. **If Status = â€œPending Verificationâ€:**
    - Create Admin Notifications record:
        - Assigned To: [Admin User ID]
        - Priority: â€œUrgentâ€
        - Notification Category: â€œLesson Verificationâ€
        - Title: â€œğŸš¨ URGENT: Lesson Verification Required - [Tutor Name] / [Student Name]â€
        - Details: â€œVerification checklist:
            - Over-delivery verified: [TRUE/FALSE]
            - Late cancellation verified: [TRUE/FALSE]
            - Transportation verified: [TRUE/FALSE]
            Lesson Date: [Date]
            Duration: [Hours]
            Package: [Package ID]
            Action Required: Review lesson details and verify checkboxes in Airtable.â€
        - Link to Lesson: [Lesson Record ID]
        - Link to Package: [Package Record ID]
        - Action Status: â€œPendingâ€
8. **If late submission (after 6 hours):**
    - Create Admin Notifications record:
        - Assigned To: [Admin User ID]
        - Priority: â€œRegularâ€
        - Notification Category: â€œLate Submissionâ€
        - Title: â€œLate Lesson Report - [Tutor Name] / [Student Name]â€
        - Details: â€œLesson ended at [Lesson End Time]
        Report submitted at [Submission Time] (more than 6 hours after lesson end)
        Delay: [X hours]
        Tutor: [Tutor Name]
        Student: [Student Name]
        Package: [Package ID]
        FYI: This is tracked for tutor evaluation purposes. No immediate action required.â€
        - Link to Lesson: [Lesson Record ID]
        - Link to Package: [Package Record ID]
        - Action Status: â€œCompletedâ€ (FYI notification - no action needed)
9. **Return HTTP 200 success to Softr:**
    - If Verified: â€œLesson submitted. Client will receive notification shortly.â€
    - If Pending: â€œLesson submitted. Client will be notified after verification.â€
    - Total workflow time target: <5 seconds

**Error Handling:**
- Validation errors: Return HTTP 400 with specific message
- Airtable write failure: Return HTTP 500, log error, retry once
- Email sending failure: Proceed with lesson creation, log error for follow-up
- All errors logged in n8n with full context

**Notes:**
- This workflow does NOT send client notification email
- Client email sent by Workflow L1 after verification
- Package Status Manager (PSP2) handles package completion checks

---

### Workflow L1: Generate lesson report PDF + send lesson completion email

**Responsibility:** Generate lesson report PDF and upload to Airtable

**Trigger:** Airtable automation AT-L1 when Lesson Status changes to â€œVerifiedâ€

**Actions:**
1. **Receive webhook from Airtable:**
- Lesson ID

1. **Fetch Lesson record + related records:**
    - Complete lesson details
    - Linked Package record
    - Linked Student record
    - Linked Parent record(s)
    - Linked Tutor record
2. **Generate lesson report PDF:**
    - Use PDF generation service/library (method TBD during development)
    - Template includes:
        - Student name, date, time, duration, location
        - Tutor notes, homework assigned, student progress
        - Package information (hours delivered, hours remaining)
    - Store PDF temporarily for upload
3. **Attach PDF to Airtable Lessons record:**
    - Upload to `Lesson Report PDF` attachment field
    - Permanent record storage
4. **Update Airtable Lessons record:**
    - `Lesson Report PDF Generated At` = current timestamp
5. **Download/prepare PDF (if needed):**
    - Fetch PDF file from attachment field
    - Prepare for email attachment
6. **Send email via Gmail (updates@stryvacademics.com):**
    - **To:** Parent email(s), Student email (if independent)
    - **CC:** team@stryvacademics.com
    - **Subject:** â€œLesson Report - [Student Name] - [Date]â€
    - **Body:** Email template with lesson summary
    - **Attachment:** Lesson report PDF
7. **Update Airtable Lessons record:**
    - `Lesson Completion Email Sent At` = current timestamp
8. **Return success**

**Error Handling:**
- PDF fetch failure: Log error, alert admin (indicates L1 failed)
- Email sending failure: Mark as failed, queue for retry, alert admin
- Airtable update failure: Log error but proceed (email was sent)

**Email Template:** HTML design with Stryv branding, mobile-responsive

**Notes:**
- This workflow ONLY sends email
- Does NOT generate PDF (thatâ€™s L1â€™s responsibility)
- Atomic design: single responsibility
- Only runs after PDF is successfully created
- Typical execution time: 10-20 seconds
- WhatsApp notifications deferred to Phase 2

---

### Workflow LSP1: Verification Reminder Manager

**Responsibility:** Send periodic reminders for pending lesson verifications

**Trigger:** n8n Schedule (every 24 hours at 09:00 HKT)

**Actions:**
1. **Query Airtable Lessons table:**
- `Lesson Status` = â€œPending Verificationâ€
- EITHER:
* `Last Reminder Sent At` is empty (first reminder - send immediately)
* OR `Last Reminder Sent At` > 24 hours ago (follow-up reminder)

1. **For each lesson found:**
    - Fetch lesson details, tutor name, student name, package info
    - Determine verification type(s) needed:
        - Over-Delivery Verified = FALSE â†’ â€œOver-delivery requires verificationâ€
        - Late Cancellation Verified = FALSE â†’ â€œLate cancellation requires verificationâ€
        - Transportation Verified = FALSE â†’ â€œTransportation costs require verificationâ€
    - Create Admin Notifications record:
        - Assigned To: [Admin User ID]
        - Priority: â€œUrgentâ€
        - Notification Category: â€œLesson Verificationâ€
        - Title: â€œğŸš¨ URGENT: Lesson Verification Reminder - [Lesson ID]â€
        - Details:
            
            Verification needed:
            
            Package: [Link to Package]
            
            Lesson: [Link to Lesson]
            
            Lesson Date: [Date]
            
            Tutor: [Tutor Name]
            
            Student: [Student Name]
            
            Action Required: Review lesson details and verify checkboxes in Airtable.
            
        - Link to Lesson: [Lesson Record ID]
        - Link to Package: [Package Record ID]
        - Action Status: â€œPendingâ€
    - Update Airtable Lessons record:
        - `Last Reminder Sent At` = current timestamp

**Error Handling:**
- Query failure: Log error, retry once
- Notification creation failure: Log specific lesson IDs that failed, continue with batch
- Airtable update failure: Log error but proceed (notification was created)

**Notes:**
- Runs once daily (every 24 hours)
- Covers all three verification types
- Sends same notification type each time (no escalation logic - 80-20 principle)
- Admin can identify urgency by checking lesson submission date manually

---

## TP-Series: Tutoring Package Management

### Workflow TP1: Ceate payment record + create base package invoice + send client package confirmation email

**Trigger:** Airtable automation AT-TP1 when new Tutoring Package record created

**Actions:**
1. **Receive webhook from Airtable:**

- Package ID, Student ID, Parent ID, Confirmation Date, Subject, Base Package Hours, Hourly Session Rate, Total Base Package Price
1. **Fetch related records:**
    - Student/Parent details
    - Xero Contact ID (must exist)
2. **Create Payments record** 
    - Link to Package = [this package]
    - Payment Type = â€œBase Package Invoiceâ€
    - Due Date = [Net 7 days from package confirmation date]
3. **Create invoice in Xero via API:**
    - **Contact:** Independent Student/Parent Xero Contact ID
    - **Line Items:**
        - Line Item 1:
            - Description:
                - Package ID: [Package ID]
                - Tutor: [Tutor Full Name]
                - Student: [Student Full Name]
                - Subject: [Subject(s)]
                - Mode: [Mode(s)]
                - Hours: [Base Package Hours]
                - Hourly Rate: [Hourly Lesson Rate]
                - Confirmation Date: [Confirmation Date]
                - Expiration Date: [Expiration Date]
            - Quantity: 1
            - Unit Price: [Total Base Package Price]
            - Total: [Total Base Package Price]
    - **Reference:** [Payment ID]
    - **Date:** [Confirmation Date]
    - **Due Date:** [Net 7 days from package confirmation date]
    - **Status:** AUTHORIZED
4. **Fetch invoice PDF from Xero API:**
    - Use Xero Invoice ID to get PDF
5. **Update Payments record** 
    - Invoice ID
    - Attach invoice PDF to Payment.Invoice PDF field
6. **Send email via Gmail (updates@stryvacademics.com):**
    - **To:** [Client Email (Parent or Independent Student)]
    - **CC:** team@stryvacademics.com
    - **Subject:** [Confirm with Zach]
    - **Body:** [Confirm with Zach]
    - **Attachment:** Base Package Invoice PDF from Xero
7. **Update Tutoring Packages record:**
    - `Client Package Confirmation Email Sent At` = current timestamp

**Error Handling:**
- **Parent/Student Xero Contact missing:**
* Create Admin Notifications record:
- Priority: â€œRegularâ€
- Notification Category: â€œSystem Errorsâ€
- Title: â€œ[Parent/Student] Missing Xero Contact - [Parent/Student Name] - [Package ID]â€
- Details: â€œCannot create bill. [Parent/student does not have Xero Contact ID.Required: Create Xero contact for parent/student, then manually retry bill creation.â€
- Link to Package: [Package Record ID]
- Action Status: â€œPendingâ€

- **Xero API failure:**
    - Retry once after 30 seconds
    - If still fails:
        - Create Admin Notifications record + Send email to team@stryvacademics.com (critical error)
        - Priority: â€œUrgentâ€
        - Notification Category: â€œSystem Errorsâ€
        - Title: â€œğŸš¨ URGENT: Xero Bill Creation Failed - [Package ID]â€
        - Details: â€œXero API call failed after retry.: [Package ID]: [Error message]. Required: Investigate Xero connection and manually create bill.â€
        - Link to Package: [Package Record ID]
        - Action Status: â€œPendingâ€

---

### Workflow TP2: Create payout record + create tutor bill + send tutor package confirmation email

**Responsibility:** Create tutor bill in Xero for accounts payable forecasting

**Trigger:** Airtable automation AT-TP2 when new Tutoring Package record created

**Actions:**

1. **Receive webhook from Airtable:**
- Package ID, Tutor ID, Subject, Base Package Hours, Hourly Tutor Income, Expected Base Package Tutor Earnings, Expiration Date
1. **Fetch Tutor details:**
    - Tutor Xero Contact ID (supplier)
    - Name, email, banking details
2. **Create Payouts record** 
    - Link to Package = [this package]
3. **Create Bill in Xero via API:**
    - **Contact:** Tutor Xero Contact ID (supplier type)
    - **Line Items:**
        - Description:
            - Package ID: [Package ID]
            - Tutor: [Tutor Full Name]
            - Student: [Student Full Name]
            - Subject: [Subject(s)]
            - Mode: [Mode(s)]
            - Hours: [Base Package Hours]
            - Hourly Rate: [Hourly Lesson Rate]
            - Confirmation Date: [Confirmation Date]
            - Expiration Date: [Expiration Date]
        - Quantity: 1
        - Unit Price: [Hourly Tutor Income]
        - Total: [Expected Base Package Tutor Earnings]
    - **Reference:** [Payout ID]
    - **Status:** AUTHORIZED
    - **Date:** [Confirmation Date]
    - **Due Date:** [Expiration Date]
4. **Fetch bill PDF from Xero API:**
    - Use Xero bill ID to get PDF
5. **Update Payouts record** 
    - Xero Bill ID
    - Attach bill PDF to Payout.Bill PDF field
6. **Send email via Gmail (updates@stryvacademics.com):**
    - **To:** [Tutor Email]
    - **CC:** team@stryvacademics.com
    - **Subject:** [Confirm with Zach]
    - **Body:** [Confirm with Zach]
    - **Attachment:** NONE
7. **Update Tutoring Packages:**
    - `Tutor Package Confirmation Email Sent At` = current timestamp

**Error Handling:**
- **Tutor Xero Contact missing:**
* Create Admin Notifications record:
- Priority: â€œRegularâ€
- Notification Category: â€œSystem Errorsâ€
- Title: â€œTutor Missing Xero Contact - [Tutor Name] - [Package ID]â€
- Details: â€œCannot create bill. Tutor does not have Xero Contact ID.Required: Create Xero contact for tutor, then manually retry bill creation.â€
- Link to Package: [Package Record ID]
- Action Status: â€œPendingâ€

- **Xero API failure:**
    - Retry once after 30 seconds
    - If still fails:
        - Create Admin Notifications record + Send email to team@stryvacademics.com (critical error)
        - Priority: â€œUrgentâ€
        - Notification Category: â€œSystem Errorsâ€
        - Title: â€œğŸš¨ URGENT: Xero Bill Creation Failed - [Package ID]â€
        - Details: â€œXero API call failed after retry.: [Package ID]: [Error message]Required: Investigate Xero connection and manually create bill.â€
        - Link to Package: [Package Record ID]
        - Action Status: â€œPendingâ€
    
    - **Gmail API failure:**
    * Retry once after 30 seconds
    * If still fails:
    - Create Admin Notifications record
    - Priority: â€œUrgentâ€
    - Notification Category: â€œSystem Errorsâ€
    - Title: â€œğŸš¨ URGENT: Tutor Package Email Failed - [Package ID]â€
    - Details: â€œFailed to send package notification email to tutor.: [Package ID]: [Tutor Name]: [Error message]Required: Manually send notification or retry workflow.â€
    - Link to Package: [Package Record ID]
    - Action Status: â€œPendingâ€
    

**Notes:**
- Bill created with AUTHORIZED status (shows in accounts payable for forecasting)
- Bill PDF is NOT attached to email sent to tutor
- Bill will be updated with verified details at package completion

- This notification confirms package creation and provides basic details
- Email template should be simple and action-oriented
- This is a one-time notification at package start

---

### Workflow TP3: Package Threshold Detection

**Responsibility:** Instantly check package when threshold reached and either complete or create notification

**Trigger:** Airtable automation AT-TPX when Total Hours Delivered >= Total Hours Expected

**Actions:**
1. **Receive webhook from Airtable:**
- Package ID

1. **Fetch Package record:**
    - Package Status (must be â€œActiveâ€ or â€œIn Progressâ€ to proceed)
    - Total Hours Expected, Total Hours Delivered
    - Unverified Lessons Notification Sent At
    - If Status is already â€œCompletedâ€: Exit (nothing to do)
2. **Fetch all linked Lessons for this package:**
    - Query all lessons linked to this package
    - Check verification status of each:
        - Over-Delivery Verified
        - Late Cancellation Verified
        - Transportation Verified
3. **Determine completion readiness:**
    
    **Path A: All lessons verified**
    
    - IF all verification checkboxes = TRUE:
        - Update Package Status = â€œCompletedâ€
        - Create Admin Notifications record (FYI):
            - Assigned To: [Admin User ID]
            - Priority: â€œRegularâ€
            - Notification Category: â€œPackage Managementâ€
            - Title: â€œPackage Auto-Completed - [Package ID]â€
            - Details: â€œPackage automatically completed.
            Hours Delivered: [Total Hours Delivered]
            Total Hours Expected: [Total Hours Expected]
            Completion Time: [Timestamp]
            Downstream workflows (bill, invoice, emails) are now processing.â€
            - Link to Package: [Package Record ID]
            - Action Status: â€œCompletedâ€
        - Exit workflow
    
    **Path B: Unverified lessons exist + notification NOT sent yet**
    
    - IF any verification checkbox = FALSE AND â€œUnverified Lessons Notification Sent Atâ€ is empty:
        - Create Admin Notifications record (Action Required):
            - Assigned To: [Admin User ID]
            - Priority: â€œUrgentâ€
            - Notification Category: â€œPackage Verificationâ€
            - Title: â€œğŸš¨ URGENT: Package Verification Required - [Package ID]â€
            - Details: â€œPackage cannot complete until all lessons are verified.
            Package: [Package ID]
            Total Hours Delivered: [Total Hours Delivered]
            Total Hours Expected: [Total Hours Expected]
            Unverified items:
            Action Required: Review and verify all lessons in Airtable.â€
            - Link to Package: [Package Record ID]
            - Action Status: â€œPendingâ€
        - Update Package record:
            - â€œUnverified Lessons Notification Sent Atâ€ = current timestamp
        - Exit workflow
    
    **Path C: Unverified lessons exist + notification already sent**
    
    - IF any verification checkbox = FALSE AND â€œUnverified Lessons Notification Sent Atâ€ is NOT empty:
        - Do nothing (TPSP1 handles 24-hour reminders)
        - Exit workflow
4. **Status change triggers downstream workflows**

**Error Handling:**
- Package fetch failure: Log error, create notification
- Lessons query failure: Retry once, then log error
- Status update failure: Retry once, then create notification + email team@stryvacademics.com

**Notes:**
- Instant response when package reaches threshold
- Idempotent: Wonâ€™t spam notifications if re-triggered
- **Total Hours Delivered** = Pre-Migration Hours + Hours Delivered rollup
- TPSP1 handles 24-hour reminder cycle for Path B/C cases
- Typical execution time: 2-5 seconds

---

### Workflow TP4: Update Base Package Invoice

**Trigger:** Airtable automation AT-P8 when â€œPackage Statusâ€ = â€œCompletedâ€ and â€œClient Package Completion Emailâ€ is Empty

**Actions:**
1. **Receive webhook from Airtable:**
- Package ID, Xero Invoice ID

1. **Fetch Package record:**
    - Pre-Migration Package (checkbox)
    - Pre-Migration Hours Delivered (if Pre-Migration Package = TRUE)
    - Total Hours Delivered (formula field)
    - Hourly Session Rate
2. **Fetch all Lessons records linked to Package:**
    - Lesson dates, hours counted
    - Calculate total hours from new lessons (Hours Delivered rollup)
3. **Update Xero invoice:**
    - Line 1:
        1. Package ID: [Package ID]
        2. Tutor: [Tutor Name]
        3. Student: [Student Name]
        4. Subject: [Subject(s)
        5. Mode: [Mode(s)]
        6. Hours: [Base Package Hours]
        7. Hourly Lesson Rate: [Hourly Tutor Income]
        8. Confirmation Date: [Confirmation Date]
        9. ***NEW FIELD:*** Completion Date: [Completion Date]

**Notes:**
- Base Package Invoice now includes package completion date

---

### Workflow TP5: Generate Package Report PDF

**Trigger:** Airtable automation AT-TP9 when â€œPackage Statusâ€ = â€œCompletedâ€ AND â€œPackage Report PDFâ€ is empty

**Actions:**
1. **Fetch Package record + all linked Lessons:**
- Sort lessons by date (oldest to newest)
- For each lesson: date, time, duration, location, tutor notes, homework, progress notes
- Fetch Lesson Report PDFs (if attached)
- Pre-Migration Package (checkbox) - for informational purposes only

1. **Generate consolidated Package Report PDF:**
    - **Method TBD during development with developer:**
        - Option A: Merge individual lesson report PDFs
        - Option B: Regenerate all lessons in single template
    - **PDF Structure:**
        - Cover page: Package summary, student name, tutor name, date range, total hours
            - Upload to `Package Report PDF` attachment field
        - Table of contents
        - Individual lesson reports (1 page per lesson)
        - Summary page: Total hours, attendance rate, progress overview
2. **Attach PDF to Airtable Tutoring Packages:**
3. **Update Airtable Tutoring Packages:**
    - `Package Report Generated At` = current timestamp

**Error Handling:**
- PDF generation failure: Alert admin, retry once, mark as failed
- If fails: Package completion can proceed without report (manual generation)

**Notes:**
- Estimated time: 30-60 seconds (depends on lesson count)
- This must complete before completion email (P11) sends
- Developer to determine best PDF generation approach during implementation
- **Pre-Migration Packages:** PDF includes only lessons submitted through the new system (Nov 21, 2025 onward). Pre-migration hours are tracked in package but not included in lesson-by-lesson PDF. Admin can manually send progress reports to clients if needed before package completion.

---

### Workflow TP6: Create Additional Fees Invoice

**Trigger:** Airtable automation AT-P10 when:
- â€œPackage Statusâ€ = â€œCompletedâ€
- Transportation Reimbursement > 0 OR Late Cancellation Fees > 0 OR Over-Delivered Hours > 0
- â€œAdditional Fees Invoice Created Atâ€ is empty

**Actions:**
1. **Receive webhook from Airtable:**
- Package ID

1. **Fetch Package fields directly:**
    - Transportation Reimbursement
    - Late Cancellation Fees
    - Over-Delivered Hours
    - Hourly Session Rate
    - Additional Fees Invoice Adjustment (if not empty)
    - Additional Fees Invoice Adjustment Note (if adjustment exists)
    - Student/Parent Xero Contact ID
2. **Create Payments record:**
    1. `Invoice ID` = new invoice ID
    2. `Payment Type` = Additional Fees Invoice
3. **Build Xero invoice line items:**
    1. Line 1 (Over-Delivered Hours > 0): 
        1. Package ID: [Package ID]
        2. Tutor: [Tutor Name]
        3. Student: [Student Name]
        4. Subject: [Subject(s)
        5. Mode: [Mode(s)]
        6. Over-Delivered Hours: [Over-Delivered Delivered]
        7. Hourly Lesson Rate: [Hourly Lesson Rate]
        8. Confirmation Date: [Confirmation Date]
        9. Completion Date: [Completion Date]
    2. Line 2 (IF Transportation Reimbursement > 0): 
        1. Line: â€œTransportation Reimbursementâ€
        Amount: {Transportation Reimbursement}
    3. Line 3 (IF Late Cancellation Fees > 0):
        1. Line: â€œLate Cancellation Feesâ€
        2. Amount: {Late Cancellation Fees}
    4. Line 4 (IF Payout Adjustment â‰  0):
        1. Line: {Payout Adjustment Note}
        2. Amount: {Payout Adjustment}
4. **Create invoice in Xero:**
    1. Contact: Student/Parent Xero Contact ID
    2. Line items: [as above]
    3. Total: {Total Additional Fees Invoice Amount}
    4. Status: Approved
    5. Reference: [New Payment record ID]
5. **Update Payments record:**
    - Attach additional fees invoice PDF to `Invoice PDF` attachment field
6. **Note on manual adjustments:**
If invoice already sent and admin makes adjustment after:
    - Admin manually edits invoice in Xero
    - Admin generates new PDF from Xero
    - Admin uploads new PDF to Payment.Invoice PDF field
    This is acceptable for MVP (rare edge case).
7. **Return success**

**Error Handling:**
- Xero invoice creation fails: Log error, create notification + send email to team@stryvacademics.com (critical error), retry once
- Email fails: Mark as â€œNot Sentâ€, queue for manual follow-up

**Notes:**
- Creates separate invoice from main package invoice
- Invoice sent automatically upon creation
- Triggered after package report is generated but before completion email

---

### Workflow TP7: Send Completion Email

**Trigger:** Airtable automation AT-P11 when ALL conditions met:
- â€œInvoice Updated Atâ€ populated
- â€œPackage Report Generated Atâ€ populated
- No additional fees OR â€œAdditional Fees Invoice Created Atâ€ populated
- â€œCompletion Email Sent Atâ€ is empty

**Actions:**
1. **Receive webhook from Airtable:**
- Package ID

1. **Fetch Package record + related data:**
    - Package Invoice Status (Paid/Unpaid)
    - Additional Fees Invoice ID (if exists)
    - Student/Parent details
2. **Determine email template variant:**
    
    ```
    IF Package Invoice Status = "Paid" AND no additional fees:
      Template A (Paid, No Fees)
    
    IF Package Invoice Status = "Paid" AND additional fees exist:
      Template B (Paid, With Fees)
    
    IF Package Invoice Status = "Unpaid" AND no additional fees:
      Template C (Unpaid, No Fees)
    
    IF Package Invoice Status = "Unpaid" AND additional fees exist:
      Template D (Unpaid, With Fees)
    ```
    
3. **Fetch PDFs:**
    - Package Report PDF (always fetch - from Airtable)
    - Main Invoice PDF (only if Unpaid - from Xero)
    - Additional Fees Invoice PDF (only if additional fees exist - from Xero)
4. **Send email via Gmail (updates@stryvacademics.com):**
    - **To:** Client email (Parent or Independent Student)
    - **CC:** team@stryvacademics.com
    - **Subject:** Varies by template
    - **Body:** Template-specific content
    - **Attachments:** PDFs as determined above
5. **Update Airtable Tutoring Packages:**
    - `Client Package Completion Email Sent At` = current timestamp

**Email Templates (4 variants):**

**Template A: Paid, No Additional Fees**
- Subject: â€œPackage Completed - [Student Name] - [Package ID]â€
- Attachments: Package Report PDF only

**Template B: Paid, With Additional Fees**
- Subject: â€œPackage Completed - Additional Fees Invoice - [Student Name]â€
- Body includes additional fees breakdown
- Attachments: Package Report PDF + Additional Fees Invoice PDF

**Template C: Unpaid, No Additional Fees**
- Subject: â€œPackage Completed - Payment Required - [Student Name]â€
- Body includes outstanding balance and payment instructions
- Attachments: Package Report PDF + Main Invoice PDF

**Template D: Unpaid, With Additional Fees**
- Subject: â€œPackage Completed - Payment Required - [Student Name]â€
- Body includes both invoices, total outstanding, payment instructions
- Attachments: Package Report PDF + Main Invoice PDF + Additional Fees Invoice PDF

**Error Handling:**
- PDF fetch failure: Log error, send email without missing PDF, alert admin
- Email failure: Mark as failed, queue for retry

**Notes:**
- These templates should be finalized with developer before implementation
- Single email contains all relevant information and invoices
- Client receives comprehensive package completion notification

---

### Workflow TP8: Update Tutor Bill

**Responsibility:** Update existing bill with verified package details at completion

**Trigger:** Airtable automation AT-P5 when â€œPackage Statusâ€ = â€œCompletedâ€

**Actions:**
1. **Receive webhook from Airtable:**
- Package ID, Xero Bill ID

1. **Fetch Package record:**
    - Pre-Migration Package (checkbox)
    - Pre-Migration Hours Delivered (if Pre-Migration Package = TRUE)
    - Total Hours Delivered
    - Hourly Tutor Income
    - Transportation Reimbursement
    - Late Cancellation Fees
    - Payout Adjustment (if not empty)
    - Payout Adjustment Note (if adjustment exists)
2. **Build Xero bill line items:**
    1. Line 1: 
        1. Package ID: [Package ID]
        2. Tutor: [Tutor Name]
        3. Student: [Student Name]
        4. Subject: [Subject(s)
        5. Mode: [Mode(s)]
        6. Hours: [Total Hours Delivered]
        7. Your Hourly Income: [Hourly Tutor Income]
        8. Confirmation Date: [Confirmation Date]
        9. Completion Date: [Completion Date]
    2. Line 2 (IF Transportation Reimbursement > 0): 
        1. Line: â€œTransportation Reimbursementâ€
        Amount: {Transportation Reimbursement}
    3. Line 3 (IF Late Cancellation Fees > 0):
        1. Line: â€œLate Cancellation Feesâ€
        2. Amount: {Late Cancellation Fees}
    4. Line 4 (IF Payout Adjustment â‰  0):
        1. Line: {Payout Adjustment Note}
        2. Amount: {Payout Adjustment}
3. **Update Bill in Xero:**
    - Update line items (as above)
    - Total = sum of all line items
    - Status: Keep as AUTHORIZED
4. **Return success**

**Error Handling:**
- **Xero API failure:**
* Retry once, then create notification + send email (critical error)
* Notification Type: â€œAPI Errorâ€, Priority: â€œUrgentâ€

**Notes:**
- This triggers AT-P6 which creates the Billed PO
- Bill amount reflects verified delivery (may differ from original estimate)
- Pre-Migration packages include hours delivered before system launch (Nov 16, 2025)

---

### Workflow TP9: Create Self-Billed Invoice

**Responsibility:** Create self-billed invoice (Xero Purchase Order with Billed status) with verified details at package completion

**Trigger:** Airtable automation AT-P6 when â€œBill Updated Atâ€ populated

**Actions:**
1. **Receive webhook from Airtable:**
- Package ID, Xero Bill ID

1. **Fetch Package details + Tutor details:**
    - Tutor Xero Contact ID
    - Total Hours Expected, Tutor Hourly Income
    - Pre-Migration Package (checkbox)
    - Pre-Migration Hours Delivered (if Pre-Migration Package = TRUE)
    - Total Hours Delivered (formula field)
2. **Fetch all Lessons for package:**
    - Lesson dates, hours counted, lesson details
    - Compile lesson summary
3. **Fetch Package fields directly:**
    - Total Payout Amount (for validation)
    - Total Hours Delivered
    - Tutor Hourly Income
    - Transportation Reimbursement
    - Late Cancellation Fees
    - Payout Adjustment (if not empty)
    - Payout Adjustment Note (if adjustment exists)
4. **Create PO in Xero:**
    1. Line items: exact same as updated bill
5. **Generate PO PDF from Xero:**
    - Fetch PDF via Xero API
6. **Update Payouts record:**
    - `Xero PO ID` = new PO ID from Xero
    - `Self-Billed Invoice PDF` = Upload PDF attachment
7. **Return success**

**Error Handling:**
- **Xero API failure:**
* Retry once, then create notification + send email (critical error)
* Priority: â€œUrgentâ€ - Tutor is waiting for PO to sign

**Notes:**
- PO created with BILLED status (indicates itâ€™s linked to bill)
- PO amount matches final updated bill amount
- This triggers AT-P7 which sends PO email to tutor
- Pre-Migration packages include context about pre-migration hours

---

### Workflow TP10: Send Self-Billed Invoice Email for E-Signature

**Responsibility:** Send Purchase Order PDF to tutor for e-signature

**Trigger:** Airtable automation AT-P7 when â€œPO Created Atâ€ populated

**Actions:**
1. **Receive webhook from Airtable:**
- Package ID, Xero PO ID, Tutor Email

1. **Fetch PO PDF from Xero API:**
    - Use Xero PO ID to get PDF
2. **Generate e-signature link:**
    - **Method TBD with developer:** DocuSign, HelloSign, or similar
    - Upload PO PDF to e-signature service
    - Generate unique signing link for tutor
    - Configure webhook to trigger PE1 when signed
3. **Send email via Gmail (updates@stryvacademics.com):**
    - **To:** Tutor email
    - **CC:** team@stryvacademics.com
    - **Subject:** [Confirm with Zach]
    - **Body:** [Confirm with Zach]
    - **Attachment:** PO PDF
4. **Upload PO PDF to Payouts table:**
    - Query Airtable for Payout record linked to this Package
    - Attach PO PDF to Payout.Self-Billed Invoide PDF field
5. **Update Payouts record:**
    - `Tutor Package Completion Email Sent At` = current timestamp

**Error Handling:**
- **E-signature service failure:** Send email without e-signature, create notification
- **Email sending failure:** Retry twice, then create notification + send fallback email

**Notes:**
- Tutor receives PO PDF (not Bill PDF)
- E-signature integration to be implemented with developer
- Signature completion triggers Workflow PE1 via webhook

---

### Workflow TPE1: Handle PO Signature

**Responsibility:** Process tutor PO signature and prepare payout for admin processing

**Trigger:** E-signature service webhook when tutor signs PO

**Actions:**
1. **Receive webhook from e-signature service:**
- Document ID, Signer email, Signature timestamp
- Signed document URL or PDF

1. **Download signed self-billed invoice PDF:**
    - Fetch signed document from e-signature service
2. **Update Payouts record:**
    - Query Payouts table for corresponding payout record
    - Self-Billed Invoice Signed At = signature timestamp
    - Attach signed PDF to Payout.Self-Billed Invoice PDF field (overwrites unsigned version)
    - Update Payout Status = â€œApprovedâ€
3. **Create Admin Notifications record:**
    - Assigned To: [Admin User ID]
    - Priority: â€œRegularâ€
    - Notification Category: â€œPayout Neededâ€
    - Title: â€œ[Tutor Name] - PO Signed - Ready for Payout - [Package ID]â€
    - Details: â€œTutor has signed Purchase Order and is ready for payout.
    Package: [Package ID]
    Tutor: [Tutor Name]
    Amount: HKD [Payout Amount]
    Signed At: [Timestamp]
    Action Required: Process payout via bank transfer, then update Payout Status to â€˜Sentâ€™.â€
    - Link to Package: [Package Record ID]
    - Link to Payout: [Payout Record ID]
    - Action Status: â€œPendingâ€

**Error Handling:**
- **Invalid signature webhook:** Create notification with webhook payload
- **Airtable update failure:** Retry once, then create notification + send email (critical)

**Notes:**
- Webhook signature validation to be implemented with developer
- Signed PO PDF provides permanent audit trail
- Payout Status = â€œApprovedâ€ indicates ready for admin processing

---

### Workflow TPSP1: Package Verification Reminder Manager

**Responsibility:** Send 24-hour reminders for packages with unverified lessons blocking completion

**Trigger:** n8n Schedule (every 24 hours at 09:00 HKT)

**Actions:**
1. **Query Airtable Tutoring Packages:**
- Total Hours Delivered >= Total Hours Expected
- Package Status = â€œIn Progressâ€ (not â€œCompletedâ€)
- Has unverified lessons (check linked Lessons for any verification checkbox = FALSE)
- â€œUnverified Lessons Notification Sent Atâ€ > 24 hours ago

1. **For each package found:**
    - Fetch package details, linked lessons, tutor name, student name
    - Determine which lessons need verification:
        - Over-Delivery Verified = FALSE â†’ â€œOver-delivery requires verificationâ€
        - Late Cancellation Verified = FALSE â†’ â€œLate cancellation requires verificationâ€
        - Transportation Verified = FALSE â†’ â€œTransportation costs require verificationâ€
    - Create Admin Notifications record:
        - Assigned To: [Admin User ID]
        - Priority: â€œUrgentâ€
        - Notification Category: â€œPackage Verificationâ€
        - Title: â€œğŸš¨ URGENT: Package Verification Reminder - [Package ID]â€
        - Details:
        
        > Package ready to complete but waiting on lesson verification.
        - Package: [Package ID]
        - Tutor: [Tutor Name]
        - Student: [Student Name]
        - Unverified lessons: [links to unverified lessons]
        - Action Required: Review and verify all lessons in Airtable.â€
        > 
        - Link to Package: [Linked to Package]
        - Action Status: â€œPendingâ€
    - Update Airtable Tutoring Packages record:
        - â€œUnverified Lessons Notification Sent Atâ€ = current timestamp

**Error Handling:**
- Query failure: Log error, retry once
- Notification creation failure: Log specific package IDs that failed, continue with batch
- Airtable update failure: Log error but proceed (notification was created)

**Notes:**
- Runs once daily (every 24 hours)
- Only reminds for packages that reached threshold but canâ€™t complete
- Prevents completion notification spam (idempotent with timestamp check)
- Admin can prioritize based on how long package has been waiting

---

## PAY-Series: Payment Tracking

### Workflow PAYE1: Client Payment Received

**Trigger:** Xero webhook when invoice payment reconciled

**Actions:**
1. **Receive Xero webhook:**
- Invoice ID, Payment amount, Payment date
- Verify webhook signature

1. **Find matching Airtable Tutoring Packages record:**
    - Match via `Xero Invoice ID` field
2. **Update Payment record:**
    - Query Airtable for Payment record:
        - Xero Invoice ID = [webhook invoice ID]
        - Payment Type = â€œMain Invoiceâ€
    - Update:
        - Payment Status = â€œPaidâ€
        - Paid At = payment date from webhook
        - Payment Method = [from Xero if available]
        - Payment Reference = [transaction reference from webhook]
3. **Update Airtable Tutoring Packages:**
    - Calculate payment status:
        - IF payment amount >= invoice total: `Package Invoice Status` = â€œPaidâ€
        - IF payment amount < invoice total: `Package Invoice Status` = â€œPartially Paidâ€
    - Update `Package Payment Received At` = payment date
4. **Send payment confirmation email via Gmail (updates@stryvacademics.com):**
    - **To:** Client email
    - **Subject:** â€œPayment Received - [Package ID]â€
    - **Body:** Payment confirmation template with amount, date, receipt
    - Can share base template with PAYE2 and PAYE3
5. **Update Airtable:**
    - `Client Payment Confirmation Sent At` = current timestamp

**Error Handling:**
- Webhook signature invalid: Reject request, log security event
- Package not found: Log error, alert admin
- Email failure: Mark as failed, queue for retry

---

### Workflow PAYE2: Tutor Payout Made

**Trigger:** Xero webhook when bill payment made

**Actions:**
1. **Receive Xero webhook:**
- Bill ID, Payment amount, Payment date
- Verify webhook signature

1. **Find matching Airtable Tutoring Packages record:**
    - Match via `Xero Bill ID` field
2. **Update Payout record:**
    - Query Airtable for Payout record linked to Package
    - Update:
        - Payout Status = â€œPaidâ€
        - Payout Made At = payment date from webhook
        - Payment Method = [from Xero if available]
        - Payment Reference = [transaction reference from webhook]
3. **Update Package (remove Payout Status field update):**
    - Payout Made At = timestamp (for audit trail)
4. **Send payout confirmation email via Gmail:**
    - **To:** Tutor email
    - **Subject:** â€œPayout Processed - [Package ID]â€
    - **Body:** Payout confirmation template with amount, date
5. **Update Airtable:**
    - `Tutor Payout Confirmation Sent At` = current timestamp

**Notes:**
- **Processing Status:** Admin should manually set Payout Status = â€œProcessingâ€ in Payouts table after sending bank transfer. This workflow (PAYE2) will update to â€œPaidâ€ once Xero confirms reconciliation (typically 1-2 days later).
- Status flow: Unpaid â†’ Processing (manual) â†’ Paid (automatic via PAYE2)

---

### Workflow PAYE3: Additional Fees Payment Received

**Trigger:** Xero webhook when additional fees invoice payment reconciled

**Actions:**
1. **Receive Xero webhook:**
- Invoice ID, Payment amount, Payment date
- Verify webhook signature

1. **Find matching Airtable Tutoring Packages record:**
    - Match via `Xero Additional Fees Invoice ID` field
2. **Update Payment record:**
    - Query Airtable for Payment record:
        - Xero Invoice ID = [webhook invoice ID]
        - Payment Type = â€œAdditional Fees Invoiceâ€
    - Update:
        - Payment Status = â€œPaidâ€
        - Paid At = payment date from webhook
        - Payment Method = [from Xero if available]
        - Payment Reference = [transaction reference from webhook]
3. **Update Airtable Tutoring Packages:**
    - `Additional Fees Invoice Status` = â€œPaidâ€
    - `Additional Fees Payment Received At` = payment date
4. **Send payment confirmation email via Gmail:**
    - **To:** Client email
    - **Subject:** â€œAdditional Fees Payment Received - [Package ID]â€
    - **Body:** Payment confirmation template
5. **Update Airtable:**
    - `Additional Fees Payment Confirmation Sent At` = current timestamp

---

## U-Series: User Management

### Workflow UE1: New Tutor Application

**Trigger:** Website form submission (applicant submits tutor application on website)

**Actions:**
1. **Receive Webflow webhook:**
- Validate webhook token
- Extract form data: Name, Email, Phone, Subjects, Experience, etc.

1. **Validate form data:**
    - All required fields present
    - Email format valid
    - Phone format valid
2. **Create Airtable Tutor Applications record:**
    - All form field data
    - Initial Screening Status = â€œTo-be-scheduledâ€
    - Overall Application Status = â€œNewâ€
    - Created At = current timestamp
3. **Create Admin Notifications record:**
    - Assigned To: [Admin User ID]
    - Priority: â€œRegularâ€
    - Notification Category: â€œTutor Pipelineâ€
    - Title: â€œNew Tutor Application - [Name]â€
    - Details: â€œNew tutor application received.
    Applicant: [Name]
    Email: [Email]
    Phone: [Phone]
    Subjects: [Subjects]
    Action Required: Review application and schedule initial screening.â€
    - Link to Tutor Application: [Application Record ID]
    - Action Status: â€œPendingâ€
4. **Send confirmation to applicant:**
    - Subject: â€œApplication Received - Stryv Academicsâ€
    - Body: Thank you message, next steps, timeline
5. **Return success to Webflow**

**Error Handling:**
- Invalid webhook token: Reject request
- Validation failure: Log error, alert admin with partial data
- Airtable write failure: Retry once, then alert admin urgently

---

### Workflow U1: Universal Xero Contact Handler

**Responsibility:** Create/link Xero contacts for all roles with duplicate detection; supports two calling patterns

**Trigger:** AT-T1, AT-P1, AT-S1, AT-S2 (Pattern A), or direct call from U2 (Pattern B)

**Calling Patterns:**

**Pattern A: Via Automation (Role Record ID provided)**
- Input: `{recordType: "Parent"/"Student"/"Tutor", recordId: "rec123..."}`
- Returns: Success/Failure (updates role record directly with Xero ID)
- Used by: AT-T1, AT-P1, AT-S1, AT-S2

**Pattern B: Direct from U2 (User Record ID provided)**
- Input: `{userId: "rec456...", contactType: "Customer"/"Supplier"}`
- Returns: `{xeroContactId: "xxx-xxx-xxx", success: true}`
- Used by: U2 workflow for sequential Parent creation

**Actions:**

1. **Determine calling pattern:**
    - IF `recordId` provided: Pattern A (automation call)
    - IF `userId` provided: Pattern B (direct call from U2)
2. **Fetch user data:**
    - **Pattern A:** Fetch role record â†’ Follow Link to Users â†’ Read Name/Email/Phone from Users table
    - **Pattern B:** Fetch Users record directly â†’ Read Name/Email/Phone
3. **Search Xero for existing contact:**
    - Search by email (primary match)
    - If not found, search by phone (secondary)
    - If not found, search by name (tertiary)
    - If multiple matches found: Flag for admin review, error out
4. **If existing Xero contact found:**
    - **Pattern A:** Update role record with Xero Contact ID, set Xero Contact Created At timestamp, return success
    - **Pattern B:** Return `{xeroContactId: "xxx", success: true}` to caller (U2)
5. **If NO existing Xero contact found:**
    
    **Determine contact type:**
    
    - **Pattern A:**
        - Tutor â†’ Xero Supplier contact
        - Parent â†’ Xero Customer contact
        - Student (Independent) â†’ Xero Customer contact
        - Student (Dependent) â†’ Special handling (see below)
    - **Pattern B:** Use `contactType` parameter from caller
6. **Create Xero contact (if not dependent student):**
    - Contact Type: Supplier or Customer
    - Name, Email, Phone from Users record
    - Additional details: Banking info (tutors only), billing address (parents)
7. **Special handling for dependent students (Pattern A only):**

```
IF Student.Role = "Student (Dependent)":
  - Fetch linked Parent record
  - Check if Parent.Xero Contact ID exists:
    * IF YES: Copy Parent's Xero ID to Student.Xero Contact ID
    * IF NO: Error "Parent must have Xero contact first"
  - Do NOT create new Xero contact
  - Set Student.Xero Contact Created At timestamp
  - Return success
```

1. **Update Airtable:**
    - **Pattern A:** Update role record with Xero Contact ID, set timestamp
    - **Pattern B:** Return Xero Contact ID to caller (no Airtable update)
2. **Return success or Xero Contact ID**

**Error Handling:**
- Xero API failure: Log error, retry once, notify admin
- Multiple Xero matches: Flag for manual review, notify admin with details
- Missing parent (dependent student): Error, notify admin
- Duplicate detection failure: Create contact anyway, flag for review

**Notes:**
- Single workflow handles ALL Xero contact creation
- Built-in duplicate prevention (searches before creating)
- Works for all record creation paths (leads, applications, manual)
- Pattern B enables sequential creation in U2 (Parent Xero ID before Student record)
- Dependent students never create new Xero contacts (always use Parentâ€™s)

---

### Workflow UE2: New Lead

**Trigger:** Webflow form submission (potential client inquires on website)

**Actions:**
1. **Receive Webflow webhook:**
- Validate webhook token
- Extract form data: Name, Email, Phone, Student details, Subject interest, etc.

1. **Validate form data:**
    - Required fields present
    - Email and phone format valid
2. **Create Airtable Leads record:**
    - Name, Email, Phone
    - Lead Type (Parent or Student)
    - Student Name, Student Email, Student Phone, Student Grade, Student School (if Parent lead)
    - Grade, School (if Independent Student lead)
    - Subject Interest
    - Learning Preferences, Academic Goals, Special Accommodations
    - Preferred Days and Times, Preferred Frequency
    - Preferred Modes (Online, In-Person)
    - Location, Other Location (if In-Person selected)
    - Message (optional notes from lead)
    - Lead Status = â€œNewâ€
    - Lead Source = â€œWebsiteâ€
    - Created At = current timestamp
3. **Create Admin Notifications record:**
    - Assigned To: [Admin User ID]
    - Priority: â€œUrgentâ€
    - Notification Category: â€œLeads & Growthâ€
    - Title: â€œğŸš¨ URGENT: New Lead - [Name]â€
    
    - Details: â€œNew lead captured from website.
    Name: [Name]
    Email: [Email]
    Phone: [Phone]
    Interested in: [Subjects]
    Grade: [Student Grade]
    Action Required: Review lead and initiate contact within 24 hours.â€
    - Link to Lead: [Lead Record ID]
    - Action Status: â€œPendingâ€
4. **Send confirmation to lead:**
    - Subject: â€œThank You for Your Interest - Stryv Academicsâ€
    - Body: Thank you message, what to expect next, timeline
5. **Return success to Webflow**

**Error Handling:**
- Similar to Workflow UE1

---

### Workflow U2: Convert Lead to Client

**Responsibility:** Convert lead to User + role records with sequential Xero contact creation

**Trigger:** Airtable button click in Leads table interface

**Actions:**

1. **Receive trigger from Airtable:**
    - Lead ID
2. **Fetch Lead record:**
    - Name, Email, Phone
    - Student Name, Student Email (if applicable)
    - Student Grade, School (if applicable)
    - Learning Preferences, Academic Goals, Special Accommodations (if applicable)
    - Preferred Days and Times, Preferred Frequency, Preferred Modes
    - Location (if applicable)
    - Lead Type: â€œParentâ€ OR â€œStudentâ€
3. **Validate Lead data:**
    - All required fields present
    - No existing User record with same email(s)
    - If Parent: Student name provided (email optional - will be generated)
4. **IF Lead Type = â€œParentâ€:**
    
    **a. Create Parent User record FIRST:**
    
    ```
    Parent User = {
      "First Name": [parsed from Lead.Name],
      "Last Name": [parsed from Lead.Name],
      "Email": Lead.Email,
      "Phone": Lead.Phone,
      "Role": "Parent",
      "Status": "Active",
      "Profile Completed At": empty
    }
    ```
    
    **b. Call U1 directly (Pattern B) BEFORE creating Parent record:**
    ```
    U1_Response = call_U1_synchronous({
    userId: [Parent User Record ID],
    contactType: â€œCustomerâ€
    })
    

IF U1_Response.success == false:
Rollback Parent User record
Error and exit

Store: parent_xero_id = U1_Response.xeroContactId

```

   **c. Create Parent record WITH Xero ID pre-populated:**
```

Parent Record = {
â€œLink to Usersâ€: [Parent User Record ID],
â€œXero Contact IDâ€: parent_xero_id,
â€œXero Contact Created Atâ€: current timestamp
// Billing Address: empty (filled by parent during profile completion in Softr)
// Payment Method: empty (filled by parent during profile completion in Softr)
}

```
   **AT-P1 does NOT trigger** (Xero Contact ID already populated) âœ…

   **d. Create Student User record:**
```

Student Email = determine_student_email(Lead.Student Email, Lead.Email, Student First Name)

Student User = {
â€œFirst Nameâ€: [parsed from Lead.Student Name],
â€œLast Nameâ€: [parsed from Lead.Student Name],
â€œEmailâ€: Student Email,
â€œPhoneâ€: Lead.Student Phone OR Lead.Phone,
â€œRoleâ€: â€œStudent (Dependent)â€,
â€œStatusâ€: â€œActiveâ€,
â€œProfile Completed Atâ€: empty
}

```

   **e. Create Student record:**
```

Student Record = {
â€œLink to Usersâ€: [Student User Record ID],
â€œLink to Parentsâ€: [Parent Record ID],
â€œXero Contact IDâ€: empty, // Will be set by AT-S1
â€œGradeâ€: Lead.Student Grade,
â€œSchoolâ€: Lead.Student School,
â€œLearning Preferencesâ€: Lead.Learning Preferences,
â€œAcademic Goalsâ€: Lead.Academic Goals,
â€œSpecial Accommodationsâ€: Lead.Special Accommodations,
â€œPreferred Days and Timesâ€: Lead.Preferred Days and Times,
â€œPreferred Frequencyâ€: Lead.Preferred Frequency,
â€œPreferred Modesâ€: Lead.Preferred Modes,
â€œTutoring Location Addressâ€: empty, // Filled by parent/student during profile completion in Softr
â€œBilling Addressâ€: empty // Will be auto-synced from Parent.Billing Address via AT-S3 (after parent completes profile)
}

```

   **f. AT-S1 triggers automatically:**
   - U1 (Pattern A) checks: Student.Role = "Dependent"
   - U1 copies Parent's Xero Contact ID to Student.Xero Contact ID

5. **IF Lead Type = "Student" (Independent):**

   **a. Create Student User record:**
```

Student User = {
â€œFirst Nameâ€: [parsed from Lead.Name],
â€œLast Nameâ€: [parsed from Lead.Name],
â€œEmailâ€: Lead.Email,
â€œPhoneâ€: Lead.Phone,
â€œRoleâ€: â€œStudent (Independent)â€,
â€œStatusâ€: â€œActiveâ€,
â€œProfile Completed Atâ€: empty
}

```

   **b. Create Student record:**
```

Student Record = {
â€œLink to Usersâ€: [Student User Record ID],
â€œLink to Parentsâ€: empty,
â€œXero Contact IDâ€: empty, // Will be set by AT-S1
â€œGradeâ€: Lead.Grade,
â€œSchoolâ€: Lead.School,
â€œLearning Preferencesâ€: Lead.Learning Preferences,
â€œAcademic Goalsâ€: Lead.Academic Goals,
â€œSpecial Accommodationsâ€: Lead.Special Accommodations,
â€œPreferred Days and Timesâ€: Lead.Preferred Days and Times,
â€œPreferred Frequencyâ€: Lead.Preferred Frequency,
â€œPreferred Modesâ€: Lead.Preferred Modes,
â€œTutoring Location Addressâ€: empty, // Filled by student during profile completion in Softr
â€œBilling Addressâ€: empty // Filled by student during profile completion in Softr (required for independent students)
}

```

   **c. AT-S1 triggers automatically:**
   - U1 (Pattern A) creates Xero customer contact
   - U1 updates Student.Xero Contact ID

6. **Update Lead record:**
   - Lead Status = "Converted"
   - Link to User record(s)
   - Converted At = current timestamp

7. **Send success notification to admin**

8. **Return success to Airtable interface**

**Helper Function: determine_student_email()**
```

IF Lead.Student Email provided:
RETURN Lead.Student Email

ELSE:
// Generate plus-addressed email from parent
parent_local = Lead.Email.split(â€œ@â€)[0]
parent_domain = Lead.Email.split(â€œ@â€)[1]
student_first_clean = Student First Name.lower().replace(â€ â€œ,â€â€œ)
RETURN fâ€{parent_local}+{student_first_clean}@parent_domainâ€

Example:
Parent = john.smith@gmail.com
Student = Sarah
Result = john.smith+sarah@gmail.com

```

**Error Handling:**
- Lead data incomplete: Return error, list missing fields
- Duplicate email: Alert admin, offer to link to existing
- U1 (Xero) fails: Rollback all records, alert admin
- User creation succeeds but role record fails: Rollback User, alert admin

**Critical Execution Order:**
```

Parent Lead:
1. Parent User
2. U1 (Pattern B) creates Parent Xero â†’ Returns Xero ID
3. Parent Record (with Xero ID already set)
4. Student User
5. Student Record
6. AT-S1 â†’ U1 (Pattern A) copies Parentâ€™s Xero ID

Independent Student Lead:
1. Student User
2. Student Record
3. AT-S1 â†’ U1 (Pattern A) creates Xero customer
```

**Notes:**
- Pattern B call to U1 is synchronous (waits for Xero ID before proceeding)
- AT-P1 wonâ€™t trigger for Parent (Xero ID already populated)
- AT-S1 always triggers for Students (handles both independent and dependent cases)
- Plus-addressing ensures unique emails while maintaining parent connection
- Student email always unique (Softr requirement)

---

## TA-Series: Tutor Application Management

**Context:** Admin manually updates stage status fields in Tutor Applications table. Each status change triggers appropriate email workflow. Mock trial lesson reports are submitted via Airtable form and tracked for timing compliance.

**Airtable Tables:**
- Tutor Applications: Stage status tracking, scores, email timestamps
- Mock Trial Lessons: Lesson report submission tracking

**Stage Status Fields:**
- Initial Screening Status, Interview Status, Mock Trial Status, Onboarding Status
- Each field values: To-be-scheduled / Scheduled / Pass / Fail

---

### Workflow TA1: Screening Pass Email

**Trigger:** Airtable automation AT-TA1 when â€œInitial Screening Statusâ€ = â€œPassâ€

**Actions:**
1. **Receive webhook from Airtable:**
- Application ID, Applicant Email, Applicant Name

1. **Send email via Gmail (updates@stryvacademics.com):**
    - **To:** Applicant email
    - **Subject:** â€œCongratulations - Next Steps: Interview Stageâ€
    - **Body:** Acceptance email template with interview instructions
2. **Update Airtable Tutor Applications record:**
    - `Overall Application Status` = â€œInterviewâ€
    - `Screening Pass Email Sent At` = current timestamp

**Email Template:** HTML with interview scheduling instructions, what to prepare

---

### Workflow TA2: Interview Pass Email

**Trigger:** Airtable automation AT-TA2 when â€œInterview Statusâ€ = â€œPassâ€

**Actions:**
1. **Receive webhook from Airtable:**
- Application ID, Applicant Email, Applicant Name

1. **Send email via Gmail:**
    - **To:** Applicant email
    - **Subject:** â€œCongratulations - Next Steps: Mock Trialâ€
    - **Body:** Acceptance email template with mock trial instructions
2. **Update Airtable:**
    - `Overall Application Status` = â€œMock Trialâ€
    - `Interview Pass Email Sent At` = current timestamp

**Email Template:** Mock trial preparation instructions, sample lesson guidelines

---

### Workflow TA3: Mock Trial Pass Email

**Trigger:** Airtable automation AT-TA3 when â€œMock Trial Statusâ€ = â€œPassâ€

**Actions:**
1. **Receive webhook from Airtable:**
- Application ID, Applicant Email, Applicant Name

1. **Send email via Gmail:**
    - **To:** Applicant email
    - **Subject:** â€œCongratulations - Next Steps: Onboardingâ€
    - **Body:** Acceptance email template with onboarding instructions
2. **Update Airtable:**
    - `Overall Application Status` = â€œOnboardingâ€
    - `Mock Trial Pass Email Sent At` = current timestamp

**Email Template:** Onboarding process overview, link to Tutor Hub with onboarding materials, mention that portal login credentials will be sent shortly

**Email Content Updates:**
- Include WhatsApp Community invitation link in email body
- Include Airtable form link for mock trial lesson report submission
- Mention 6-hour deadline for lesson report submission

**Note:** Portal access email (with login instructions) is sent by TA3b workflow after account creation

---

### Workflow TA3b: Create User Account & Send Login Instructions

**Responsibility:** Convert approved application to User + Tutor records, trigger Xero contact creation

**Trigger:** Airtable automation AT-TA3b when Mock Trial Pass Email Sent At is populated

**Actions:**

1. **Receive webhook from Airtable:**
    - Application ID, Applicant Email, Applicant Name
2. **Fetch Tutor Application record:**
    - Parse name into First Name + Last Name
    - Email, Phone
    - Subjects, Education details, Banking details
3. **Create User record FIRST:**

```
User Record = {
  "First Name": [parsed from application name],
  "Last Name": [parsed from application name],
  "Email": application email,
  "Phone": application phone,
  "Role": "Tutor",
  "Status": "Active",
  "Profile Completed At": empty
}
```

1. **Create Tutor record SECOND (linked to User):**

```
Tutor Record = {
  "Link to Users": [User Record ID from step 3],
  "Subjects": [from application],
  "Education Level": [from application],
  "University": [from application],
  "Bank Name": [from application],
  "Bank Account Number": [from application],
  "Bank Account Name": [from application],
  // Full Name, Email, Phone are LOOKUPS - not stored
}
```

1. **AT-T1 triggers automatically:**
    - AT-T1 calls U1 (Pattern A)
    - U1 creates Xero supplier contact
    - Xero Contact ID stored in Tutor record
2. **Send login instructions email via Gmail:**
    - **To:** User email
    - **Subject:** â€œWelcome to Stryv - Portal Accessâ€
    - **Body:** Login instructions, profile completion reminder, portal link
3. **Update Tutor Applications record:**
    - `User Account Created At` = current timestamp
    - `Account Activation Email Sent At` = current timestamp
    - Link to User record
    - Link to Tutor record
4. **Return success**

**Error Handling:**
- Name parsing failure: Use full name as First Name, empty Last Name, alert admin
- User creation fails: Abort, do not create Tutor record
- Tutor creation fails: Delete User record (rollback), alert admin
- Email sending fails: Mark for manual send, but proceed (account created)

**Critical Execution Order:**

```
1. User record created
2. Tutor record created (links to User)
3. AT-T1 triggers â†’ U1 creates Xero supplier
```

**Notes:**
- Order critical: User â†’ Tutor â†’ Xero (via AT-T1 automation)
- Tutor record stores ONLY tutor-specific fields
- User data retrieved via lookups in Tutor table
- Xero contact creation happens automatically via AT-T1
- Profile completion in Softr grants full portal access (no additional workflow)

---

### Workflow TA4: Onboarding Pass Email

**Responsibility:** Send congratulations email after onboarding call passes, update completion timestamp

**Trigger:** Airtable automation AT-TA4 when Onboarding Status = â€œPassâ€

**Actions:**
1. **Receive webhook from Airtable:**
- Application ID, Applicant Email, Applicant Name

1. **Fetch Application + linked User record**
2. **Send congratulations email via Gmail:**
    - **To:** User email
    - **Subject:** â€œCongratulations - Youâ€™ve Completed Onboarding!â€
    - **Body:** â€œYouâ€™ve successfully completed onboarding! Your profile access will be available as soon as you complete your profile setup at [portal link].â€
3. **Update Tutor Applications record:**
    - `Overall Application Status` = â€œCompletedâ€
    - `Onboarding Pass Email Sent At` = current timestamp
4. **Return success**

**Error Handling:**
- User fetch failure: Log error, retry once
- Email failure: Mark as failed, queue for manual send

**Notes:**
- Profile completion handled by Softr (grants access when Profile Completed At is populated)
- User Status already â€œActiveâ€ (set by TA3b)
- Single email template (no conditional logic)
- Typical execution time: 2-3 seconds

---

### Workflow TA5: Application Rejection Email

**Trigger:** Airtable automation AT-TA5 when ANY stage status field = â€œFailâ€

**Actions:**
1. **Receive webhook from Airtable:**
- Application ID, Applicant Email, Applicant Name

1. **Send email via Gmail:**
    - **To:** Applicant email
    - **Subject:** â€œThank You for Your Applicationâ€
    - **Body:** Standard rejection email template (same for all stages)
2. **Update Airtable:**
    - `Overall Application Status` = â€œRejectedâ€
    - `Rejection Email Sent At` = current timestamp

**Email Template:** Professional rejection, encouragement to reapply in future

**Note:** Same email template used regardless of which stage failed

---

### Workflow TASP1: Mock Trial Missing Report Detection

**Responsibility:** Daily check for missing mock trial lesson reports, update status and create notifications

**Trigger:** n8n Schedule (every 24 hours at 10:00 HKT)

**Actions:**
1. **Query Airtable Tutor Applications table:**
- `Mock Trial Status` = â€œPassâ€
- `Mock Trial Date` is populated
- `Mock Trial Date` was > 6 hours ago
- `Link to Mock Trial Lesson` is empty (no report submitted)

1. **For each application found:**
    - Calculate hours elapsed since Mock Trial Date
    - Create Admin Notifications record:
        - Assigned To: [Admin User ID]
        - Priority: â€œRegularâ€
        - Notification Category: â€œTutor Pipelineâ€
        - Title: â€œMissing Mock Trial Report - [Applicant Name]â€
        - Details: â€œMock trial lesson report has not been submitted.
        Applicant: [Applicant Name]
        Mock Trial Date: [Date]
        Hours Elapsed: [X hours]
        Action Required: Follow up with applicant or manually review submission status.â€
        - Link to Tutor Application: [Application Record ID]
        - Action Status: â€œPendingâ€
2. **Query Mock Trial Lessons table:**
    - `Lesson Report Status` = â€œAwaiting Submissionâ€
    - `Mock Trial Date` was > 6 hours ago (via Lookup from Application)
3. **For each lesson found:**
    - Update Mock Trial Lessons record:
        - `Lesson Report Status` = â€œMissingâ€

**Error Handling:**
- Query failure: Log error, retry once
- Notification creation failure: Log specific application IDs that failed, continue with batch
- Status update failure: Log error but proceed (notification was created)

**Notes:**
- Runs once daily to batch-check all pending reports
- Only creates one notification per application (checks if notification already exists)
- Updates status in Mock Trial Lessons table for visibility
- Follows same notification pattern as LSP1 (lesson verification reminders)

---

## Email Template Summary

**Total Templates: 22**

### L-Series (2 templates)

1. Lesson report notification (L1)
2. Late lesson report admin alert (LE1)

### TA-Series (6 templates)

1. Screening pass (TA1)
2. Interview pass (TA2)
3. Mock trial pass (TA3)
4. Portal login instructions (TA3b)
5. Onboarding pass (TA4 - Single template)
6. Rejection (TA5)

### TP-Series (10 templates)

1. Tutor package notification (TP4)
2. Invoice email to client (TP2)
3. PO signature request to tutor (TP7)
4. PO signature confirmation (TPE1)
5. Completion Template A: Paid, No Fees (TP11)
6. Completion Template B: Paid, With Fees (TP11)
7. Completion Template C: Unpaid, No Fees (TP11)
8. Completion Template D: Unpaid, With Fees (TP11)
9. Additional fees invoice (TP10)

### PAY-Series (1 shared template)

1. Payment confirmation (PAYE1/PAYE2/PAYE3 - can share base template)

### U-Series (2 templates)

1. New tutor application confirmation (UE1)
2. New lead confirmation (UE2)

### Admin Notification Templates

1. Various admin notification templates (created by multiple workflows)

**Design Requirements:**
- Mobile-responsive
- Stryv branding (logo, colors)
- HTML + inline CSS (for email compatibility)
- Clear call-to-action buttons
- Professional tone

**Note:** Completion email templates (14-17) should be reviewed and finalized with developer before implementation.

---